rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isSignedIn() { return request.auth != null; }
    function isSelf(uid) { return isSignedIn() && uid == request.auth.uid; }
    function userDoc() {
      return isSignedIn() ? get(/databases/$(database)/documents/users/$(request.auth.uid)).data : null;
    }
    function hasRole(r) {
      return userDoc() != null && (
        userDoc().role == r ||
        (userDoc().roles != null && userDoc().roles.hasAny([r]))
      );
    }
    function isAdmin() { return hasRole('admin'); }
    function isClient() { return hasRole('client'); }
    function isProvider() { return hasRole('service_provider') || hasRole('provider'); }
    function roleChanging() {
      return resource != null && resource.data.diff(request.resource.data).changedKeys().hasAny(['role']);
    }

    match /users/{uid} {
      allow create: if (isSelf(uid) && (request.resource.data.role == 'client' || request.resource.data.roles.hasAny(['client']))) || isAdmin();
      allow read: if isSelf(uid) || isAdmin();
      allow update: if (isSelf(uid) && !roleChanging()) || isAdmin();
      allow delete: if isAdmin();
    }

    match /categories/{id} {
      allow read: if true;
      allow write: if isAdmin();
    }

    match /providers/{id} {
      allow read: if true;
      allow write: if isAdmin();
    }

    match /bookings/{id} {
      allow read: if isSignedIn() && (
        isAdmin() ||
        (isClient() && resource.data.clientUid == request.auth.uid) ||
        (isProvider() && (
          resource.data.providerUid == request.auth.uid ||
          resource.data.provider_id == request.auth.uid
        ))
      );
      allow create: if isSignedIn() && (
        (isClient() && request.resource.data.clientUid == request.auth.uid) ||
        isAdmin() ||
        (isProvider() && (
          request.resource.data.providerUid == request.auth.uid ||
          request.resource.data.provider_id == request.auth.uid
        ))
      );
      allow update, delete: if isSignedIn() && (
        isAdmin() ||
        (isClient() && resource != null && resource.data.clientUid == request.auth.uid) ||
        (isProvider() && resource != null && (
          resource.data.providerUid == request.auth.uid ||
          resource.data.provider_id == request.auth.uid
        ))
      );
    }

    match /returns/{id} {
      allow read: if isSignedIn() && (isAdmin() || (isClient() && resource.data.clientUid == request.auth.uid));
      allow create: if isSignedIn() && ((isClient() && request.resource.data.clientUid == request.auth.uid) || isAdmin());
      allow update, delete: if isSignedIn() && (isAdmin() || (isClient() && resource.data.clientUid == request.auth.uid));
    }

    match /chats/{chatId} {
      allow read: if isSignedIn() && request.auth.uid in resource.data.participantIds;
      allow create: if isSignedIn() && request.auth.uid in request.resource.data.participantIds && request.resource.data.participantIds.size() == 2 && request.resource.data.bookingId is string && request.resource.data.lastMessageAt is timestamp;
      allow update: if isSignedIn() && request.auth.uid in resource.data.participantIds && request.resource.data.participantIds == resource.data.participantIds && request.resource.data.bookingId == resource.data.bookingId;

      match /messages/{messageId} {
        allow read: if isSignedIn() && request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participantIds;
        allow create: if isSignedIn() && request.resource.data.senderId == request.auth.uid && request.resource.data.chatId == chatId && request.resource.data.text is string && request.resource.data.createdAt is timestamp;
        allow update: if isSignedIn() && resource.data.senderId == request.auth.uid && request.resource.data.senderId == resource.data.senderId && request.resource.data.chatId == resource.data.chatId;
        allow delete: if false;
      }
    }
  }
}
