# Render Deployment Configuration for MySQL Database Setup
# This configuration connects to your external MySQL Docker database

services:
  # Laravel API Backend with MySQL Database
  - type: web
    name: haustap-api-mysql
    env: docker
    dockerfilePath: ./backend/api/Dockerfile.mysql
    dockerContext: ./backend/api
    envVars:
      - key: APP_NAME
        value: HausTap API
      - key: APP_ENV
        value: production
      - key: APP_DEBUG
        value: false
      - key: APP_URL
        value: https://haustap-api-mysql.onrender.com
      - key: DB_CONNECTION
        value: mysql
      - key: DB_HOST
        value: host.docker.internal  # Connect to Docker MySQL
      - key: DB_PORT
        value: 3307
      - key: DB_DATABASE
        value: haustap_db
      - key: DB_USERNAME
        value: haustap_user
      - key: DB_PASSWORD
        value: haustap_password
      - key: SESSION_DRIVER
        value: database
      - key: CACHE_STORE
        value: database
      - key: QUEUE_CONNECTION
        value: database
      - key: BROADCAST_CONNECTION
        value: log
      - key: FILESYSTEM_DISK
        value: local
      - key: LOG_CHANNEL
        value: stderr
      - key: LOG_LEVEL
        value: info
      - key: FRONTEND_URL
        value: https://haustap-web.onrender.com
      - key: MOBILE_APP_URL
        value: https://haustap-mobile.onrender.com
      - key: FIREBASE_PROJECT_ID
        value: haustap-firebase
    buildCommand: |
      cp .env.mysql.production .env
      php artisan key:generate --ansi
      php artisan migrate --force --seed
      php artisan cache:clear
      php artisan config:clear
      chmod -R 755 storage bootstrap/cache
    startCommand: php artisan serve --host=0.0.0.0 --port=8000
    healthCheckPath: /api/health
    autoDeploy: true

  # Web Frontend (PHP Website)
  - type: web
    name: haustap-web-mysql
    env: docker
    dockerfilePath: ./Dockerfile.web
    dockerContext: ./Haustap_Capstone-Haustap_Connecting
    envVars:
      - key: API_BASE_URL
        value: https://haustap-api-mysql.onrender.com
      - key: APP_ENV
        value: production
      - key: PHP_VERSION
        value: 8.2
    buildCommand: |
      # Install dependencies and setup web frontend
      docker-php-ext-install pdo_mysql mysqli
      a2enmod rewrite
      # Set proper permissions
      chown -R www-data:www-data /var/www/html
      chmod -R 755 /var/www/html
    startCommand: apache2-foreground
    healthCheckPath: /
    autoDeploy: true

  # Static Site for Mobile App Documentation/Assets
  - type: web
    name: haustap-mobile-mysql
    env: static
    buildCommand: |
      echo "Mobile app support service ready"
    staticPublishPath: ./mobile-static
    envVars:
      - key: API_BASE_URL
        value: https://haustap-api-mysql.onrender.com
    headers:
      - path: /*
        name: Access-Control-Allow-Origin
        value: "*"
      - path: /*
        name: Access-Control-Allow-Methods
        value: "GET, POST, PUT, DELETE, OPTIONS"
      - path: /*
        name: Access-Control-Allow-Headers
        value: "Content-Type, Authorization, X-Requested-With"